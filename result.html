<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-6098747212157218"
         crossorigin="anonymous"></script>
    <title>최근 테스트 결과 | 모두의 테스트</title>
    <meta name="description" content="최근 테스트 결과를 확인하고 추천 테스트를 이어서 즐겨보세요.">
    <meta name="robots" content="index,follow,max-image-preview:large">
    <link rel="canonical" href="https://sunyeonkim.github.io/mbti/result.html">
    <meta property="og:site_name" content="모두의 테스트">
    <meta property="og:type" content="website">
    <meta property="og:title" content="최근 테스트 결과 | 모두의 테스트">
    <meta property="og:description" content="최근 테스트 결과를 확인하고 추천 테스트를 이어서 즐겨보세요.">
    <meta property="og:url" content="https://sunyeonkim.github.io/mbti/result.html">
    <meta name="twitter:card" content="summary">
    <meta name="twitter:title" content="최근 테스트 결과 | 모두의 테스트">
    <meta name="twitter:description" content="최근 테스트 결과를 확인하고 추천 테스트를 이어서 즐겨보세요.">
    <link rel="stylesheet" href="style.css">
</head>
<body>
    <header class="top-bar">
        <div class="top-bar-left">
            <a class="top-bar-logo" href="index.html">모두의 테스트</a>
        </div>
    </header>

    <main class="page-main">
        <div class="container wide-container">
            <a href="index.html" class="primary-link page-back-link">← 메인으로</a>
            <h1>최근 테스트 결과</h1>
            <img id="recent-result-guide-image" class="result-guide-image recent-result-guide-image" alt="result guide" hidden>
            <section id="result-detail" class="content-section" hidden>
                <h2 id="result-test-title"></h2>
                <div id="result-type" class="recent-result-type"></div>
                <div id="result-description" class="intro-copy"></div>
                <div id="result-share-section" class="share-section" hidden>
                    <p class="share-title">공유하기</p>
                    <div class="share-icons">
                        <button class="share-btn" type="button" data-share-type="copy" aria-label="Copy link"></button>
                        <button class="share-btn" type="button" data-share-type="kakao" aria-label="Share to KakaoTalk">K</button>
                        <button class="share-btn" type="button" data-share-type="x" aria-label="Share to X">X</button>
                        <button class="share-btn" type="button" data-share-type="naver" aria-label="Share to Naver Blog">N</button>
                    </div>
                </div>
                <section id="recent-result-recommended-section" class="result-recommended-section" hidden>
                    <h3 class="result-recommended-heading">추천 테스트</h3>
                    <div id="recent-result-recommended-list" class="result-recommended-grid"></div>
                </section>
            </section>
            <p id="result-empty" class="empty-message" hidden>결과 정보를 찾을 수 없습니다.</p>
        </div>
    </main>

    <footer class="site-footer">
        <div class="site-footer-inner">
            <p>© 2026 모두의 테스트. All rights reserved.</p>
            <div class="text-link-list footer-links">
                <a href="privacy.html">개인정보처리방침</a>
                <a href="terms.html">이용약관</a>
                <a href="contact.html">문의하기</a>
            </div>
        </div>
    </footer>
    <div id="toast" class="toast" role="status" aria-live="polite" hidden></div>

    <script defer src="https://www.gstatic.com/firebasejs/10.14.1/firebase-app-compat.js"></script>
    <script defer src="https://www.gstatic.com/firebasejs/10.14.1/firebase-firestore-compat.js"></script>
    <script defer src="firebase-config.js"></script>
    <script>
        (function initResultPageModule() {
            const COPY_ICON_SVG = `
            <svg class="doc-copy-icon" viewBox="0 0 24 24" aria-hidden="true" focusable="false">
                <rect x="9" y="7" width="10" height="12" rx="2" ry="2"></rect>
                <path d="M15 7V5a2 2 0 0 0-2-2H7a2 2 0 0 0-2 2v10a2 2 0 0 0 2 2h2"></path>
            </svg>`;
            const RECENT_RESULTS_STORAGE_KEY = "recentTestResultsV1";

            const detailEl = document.getElementById("result-detail");
            const emptyEl = document.getElementById("result-empty");
            const titleEl = document.getElementById("result-test-title");
            const typeEl = document.getElementById("result-type");
            const descriptionEl = document.getElementById("result-description");
            const recentGuideImageEl = document.getElementById("recent-result-guide-image");
            const shareSectionEl = document.getElementById("result-share-section");
            const recommendedSectionEl = document.getElementById("recent-result-recommended-section");
            const recommendedListEl = document.getElementById("recent-result-recommended-list");
            const toastEl = document.getElementById("toast");

            let toastTimer = null;
            let shareContext = null;

            function showToast(message) {
                if (!toastEl) {
                    return;
                }
                toastEl.textContent = message;
                toastEl.hidden = false;
                toastEl.classList.add("show");
                if (toastTimer) {
                    clearTimeout(toastTimer);
                }
                toastTimer = setTimeout(() => {
                    toastEl.classList.remove("show");
                    toastEl.hidden = true;
                }, 1800);
            }

            function copyTextToClipboard(text) {
                if (navigator.clipboard && typeof navigator.clipboard.writeText === "function") {
                    return navigator.clipboard.writeText(text);
                }
                return new Promise((resolve, reject) => {
                    const temp = document.createElement("input");
                    temp.value = text;
                    document.body.appendChild(temp);
                    temp.select();
                    const success = document.execCommand("copy");
                    document.body.removeChild(temp);
                    if (success) {
                        resolve();
                    } else {
                        reject(new Error("copy_failed"));
                    }
                });
            }

            function escapeHtml(value) {
                return String(value || "")
                    .replace(/&/g, "&amp;")
                    .replace(/</g, "&lt;")
                    .replace(/>/g, "&gt;")
                    .replace(/\"/g, "&quot;")
                    .replace(/'/g, "&#39;");
            }

            function sanitizeAdminHtml(rawHtml) {
                const template = document.createElement("template");
                template.innerHTML = String(rawHtml || "");
                template.content.querySelectorAll("script,style,iframe,object,embed,link,meta").forEach((node) => {
                    node.remove();
                });
                template.content.querySelectorAll("*").forEach((el) => {
                    Array.from(el.attributes).forEach((attr) => {
                        const name = String(attr.name || "").toLowerCase();
                        const value = String(attr.value || "").trim();
                        if (name.startsWith("on") || name === "srcdoc") {
                            el.removeAttribute(attr.name);
                            return;
                        }
                        if ((name === "href" || name === "src") && /^javascript:/i.test(value)) {
                            el.removeAttribute(attr.name);
                        }
                    });
                });
                return template.innerHTML;
            }

            function renderResultContentHtml(rawText) {
                const source = String(rawText || "");
                if (!source.trim()) {
                    return "";
                }
                if (/<[a-z][\s\S]*>/i.test(source)) {
                    return sanitizeAdminHtml(source);
                }
                return escapeHtml(source).replace(/\r?\n/g, "<br>");
            }

            function setMetaTagValue(selector, attrName, attrValue, content) {
                let tag = document.head.querySelector(selector);
                if (!tag) {
                    tag = document.createElement("meta");
                    tag.setAttribute(attrName, attrValue);
                    document.head.appendChild(tag);
                }
                tag.setAttribute("content", String(content || "").trim());
            }

            function setCanonicalUrl(url) {
                let link = document.head.querySelector("link[rel='canonical']");
                if (!link) {
                    link = document.createElement("link");
                    link.setAttribute("rel", "canonical");
                    document.head.appendChild(link);
                }
                link.setAttribute("href", String(url || window.location.href));
            }

            function updateSeoMetaFromResult(latest, found) {
                const baseTitle = "모두의 테스트";
                const testTitle = String((latest && latest.testTitle) || (found && found.resultType) || "최근 테스트 결과").trim();
                const cardTitle = String((latest && latest.cardTitle) || (found && found.testTitle) || "최근 테스트 결과").trim();
                const ogImage = String((latest && latest.thumbnail) || "").trim();
                const defaultOgImage = `${window.location.origin}/resource/og-default.svg`;
                const fullTitle = `${testTitle} | ${baseTitle}`;
                const canonical = window.location.href;

                document.title = fullTitle;
                setMetaTagValue("meta[name='description']", "name", "description", cardTitle);
                setMetaTagValue("meta[property='og:title']", "property", "og:title", testTitle);
                setMetaTagValue("meta[property='og:description']", "property", "og:description", cardTitle);
                setMetaTagValue("meta[property='og:url']", "property", "og:url", canonical);
                setMetaTagValue("meta[property='og:image']", "property", "og:image", ogImage || defaultOgImage);
                setMetaTagValue("meta[name='twitter:card']", "name", "twitter:card", "summary_large_image");
                setMetaTagValue("meta[name='twitter:title']", "name", "twitter:title", testTitle);
                setMetaTagValue("meta[name='twitter:description']", "name", "twitter:description", cardTitle);
                setMetaTagValue("meta[name='twitter:image']", "name", "twitter:image", ogImage || defaultOgImage);
                setCanonicalUrl(canonical);
            }

            function resolveMatchImagePlaceholders(rawText, resultSettings) {
                const source = String(rawText || "");
                if (!source) {
                    return "";
                }
                const settings = resultSettings && typeof resultSettings === "object" ? resultSettings : {};
                return source.replace(/\{([EI][NS][TF][JP])-이미지\}/gi, (full, typeKey) => {
                    const mbti = String(typeKey || "").toUpperCase();
                    const config = settings[mbti] && typeof settings[mbti] === "object" ? settings[mbti] : {};
                    const imageUrl = String(config.image || "").trim();
                    if (!imageUrl) {
                        return "";
                    }
                    const safeUrl = escapeHtml(imageUrl);
                    const safeAlt = escapeHtml(`${mbti} 유형 이미지`);
                    return `<br><img src="${safeUrl}" alt="${safeAlt}" loading="lazy" style="display:block;max-width:100%;height:auto;border-radius:12px;margin-top:10px;">`;
                });
            }

            function isMobileDevice() {
                return /Android|iPhone|iPad|iPod/i.test(navigator.userAgent || "");
            }

            function openShareWindow(url) {
                window.open(url, "_blank", "noopener,noreferrer,width=640,height=720");
            }

            async function shareToChannel(type) {
                if (!shareContext) {
                    return;
                }
                const encodedUrl = encodeURIComponent(shareContext.shareUrl);
                const encodedText = encodeURIComponent(shareContext.text);
                const encodedTitle = encodeURIComponent(shareContext.title);

                if (type === "copy") {
                    try {
                        await copyTextToClipboard(shareContext.shareUrl);
                        showToast("링크 복사가 완료되었습니다.");
                    } catch (error) {
                        showToast("링크 복사에 실패했습니다.");
                    }
                    return;
                }

                if (type === "kakao") {
                    if (isMobileDevice() && navigator.share && typeof navigator.share === "function") {
                        try {
                            await navigator.share({
                                title: shareContext.title,
                                text: shareContext.text,
                                url: shareContext.shareUrl
                            });
                            return;
                        } catch (error) {
                            if (error && error.name === "AbortError") {
                                return;
                            }
                        }
                    }
                    if (isMobileDevice()) {
                        const fallbackUrl = `https://sharer.kakao.com/talk/friends/picker/link?url=${encodedUrl}&text=${encodedText}`;
                        const deepLink = `kakaotalk://web/openExternal?url=${encodeURIComponent(fallbackUrl)}`;
                        const fallbackTimer = window.setTimeout(() => {
                            window.location.href = fallbackUrl;
                        }, 700);
                        window.location.href = deepLink;
                        window.setTimeout(() => window.clearTimeout(fallbackTimer), 1200);
                        return;
                    }
                    openShareWindow(`https://sharer.kakao.com/talk/friends/picker/link?url=${encodedUrl}&text=${encodedText}`);
                    return;
                }

                if (type === "x") {
                    openShareWindow(`https://twitter.com/intent/tweet?url=${encodedUrl}&text=${encodedText}`);
                    return;
                }

                if (type === "naver") {
                    openShareWindow(`https://share.naver.com/web/shareView?url=${encodedUrl}&title=${encodedTitle}`);
                }
            }

            async function loadLatestDescription(found) {
                const services = window.firebaseServices || {};
                if (!services.isConfigured || !services.db || !found.testId) {
                    return {
                        title: found.resultType || "-",
                        description: found.summary || "결과 요약이 없습니다.",
                        image: "",
                        resultSettings: {},
                        testTitle: found.testTitle || "",
                        cardTitle: found.testTitle || "",
                        thumbnail: ""
                    };
                }
                try {
                    const doc = await services.db.collection("tests").doc(found.testId).get();
                    const data = doc && doc.exists ? doc.data() : null;
                    if (!data || typeof data !== "object") {
                        return {
                            title: found.resultType || "-",
                            description: found.summary || "결과 요약이 없습니다.",
                            image: "",
                            resultSettings: {},
                            testTitle: found.testTitle || "",
                            cardTitle: found.testTitle || "",
                            thumbnail: ""
                        };
                    }
                    const resultSettings = data.resultSettings && typeof data.resultSettings === "object"
                        ? data.resultSettings
                        : {};
                    const resultConfig = resultSettings[found.resultType] && typeof resultSettings[found.resultType] === "object"
                        ? resultSettings[found.resultType]
                        : {};
                    const mappedDescriptions = data.mbtiDescriptions && typeof data.mbtiDescriptions === "object"
                        ? data.mbtiDescriptions
                        : {};

                    return {
                        title: String(resultConfig.title || `${found.resultType || ""} 유형`).trim(),
                        description: String(resultConfig.content || mappedDescriptions[found.resultType] || found.summary || "결과 요약이 없습니다.").trim(),
                        image: String(resultConfig.image || data.resultImage || "").trim(),
                        resultSettings,
                        testTitle: String(data.title || data.cardTitle || found.testTitle || "").trim(),
                        cardTitle: String(data.cardTitle || data.title || found.testTitle || "").trim(),
                        thumbnail: String(data.thumbnail || "").trim()
                    };
                } catch (error) {
                    return {
                        title: found.resultType || "-",
                        description: found.summary || "결과 요약이 없습니다.",
                        image: "",
                        resultSettings: {},
                        testTitle: found.testTitle || "",
                        cardTitle: found.testTitle || "",
                        thumbnail: ""
                    };
                }
            }

            function sanitizeRemoteTest(doc) {
                const data = doc && typeof doc.data === "function" ? doc.data() : {};
                return {
                    id: doc && doc.id ? String(doc.id) : "",
                    title: String(data.cardTitle || data.title || "테스트"),
                    thumbnail: String(data.thumbnail || ""),
                    viewCount: Math.max(0, Number(data.viewCount) || 0),
                    createdAtMs: data.createdAt && typeof data.createdAt.toMillis === "function"
                        ? data.createdAt.toMillis()
                        : 0
                };
            }

            function renderRecommendedTests(testId, list) {
                if (!recommendedSectionEl || !recommendedListEl) {
                    return;
                }

                recommendedListEl.innerHTML = "";
                const items = (Array.isArray(list) ? list : [])
                    .filter((item) => item && item.id && item.id !== testId)
                    .sort((a, b) => {
                        const viewDiff = (Number(b.viewCount) || 0) - (Number(a.viewCount) || 0);
                        if (viewDiff !== 0) {
                            return viewDiff;
                        }
                        return (Number(b.createdAtMs) || 0) - (Number(a.createdAtMs) || 0);
                    })
                    .slice(0, 3);

                if (!items.length) {
                    recommendedSectionEl.hidden = true;
                    return;
                }

                items.forEach((item) => {
                    const card = document.createElement("a");
                    card.className = "result-recommended-card";
                    card.href = `index.html?test=${encodeURIComponent(item.id)}`;
                    card.setAttribute("aria-label", `${item.title} 테스트 시작`);

                    if (item.thumbnail) {
                        const img = document.createElement("img");
                        img.src = item.thumbnail;
                        img.alt = `${item.title} thumbnail`;
                        card.appendChild(img);
                    }

                    const title = document.createElement("p");
                    title.className = "result-recommended-title";
                    title.textContent = item.title;

                    const meta = document.createElement("p");
                    meta.className = "result-recommended-meta";
                    meta.textContent = `조회수 ${Math.max(0, Number(item.viewCount) || 0).toLocaleString()}`;

                    card.append(title, meta);
                    recommendedListEl.appendChild(card);
                });

                recommendedSectionEl.hidden = false;
            }

            async function loadRecommendedTests(testId) {
                const services = window.firebaseServices || {};
                if (!services.isConfigured || !services.db || !testId) {
                    renderRecommendedTests(testId, []);
                    return;
                }
                try {
                    const snapshot = await services.db.collection("tests").where("isPublished", "==", true).get();
                    const list = snapshot.docs.map((doc) => sanitizeRemoteTest(doc)).filter((item) => item.id);
                    renderRecommendedTests(testId, list);
                } catch (error) {
                    renderRecommendedTests(testId, []);
                }
            }

            async function initResultPage() {
                document.querySelectorAll('.share-btn[data-share-type="copy"]').forEach((button) => {
                    button.innerHTML = COPY_ICON_SVG;
                });
                document.querySelectorAll(".share-btn").forEach((button) => {
                    button.addEventListener("click", () => {
                        const type = button.getAttribute("data-share-type");
                        if (type) {
                            shareToChannel(type);
                        }
                    });
                });

                const params = new URLSearchParams(window.location.search);
                const recordId = params.get("record");
                const items = JSON.parse(localStorage.getItem(RECENT_RESULTS_STORAGE_KEY) || "[]");
                const found = Array.isArray(items)
                    ? items.find((item) => item && item.id === recordId)
                    : null;

                if (!found) {
                    emptyEl.hidden = false;
                    return;
                }

                const latest = await loadLatestDescription(found);
                updateSeoMetaFromResult(latest, found);
                const shareUrl = `${window.location.origin}/index.html?test=${encodeURIComponent(found.testId || "")}`;
                shareContext = {
                    shareUrl,
                    title: found.testTitle || "테스트",
                    text: `내 MBTI 결과는 ${found.resultType || ""}! ${found.testTitle || "테스트"} 해보기`
                };

                titleEl.textContent = found.testTitle || "테스트";
                typeEl.innerHTML = renderResultContentHtml(latest.title || found.resultType || "-");
                const resolvedDescription = resolveMatchImagePlaceholders(
                    latest.description || found.summary || "결과 요약이 없습니다.",
                    latest.resultSettings
                );
                descriptionEl.innerHTML = renderResultContentHtml(resolvedDescription);
                if (recentGuideImageEl) {
                    recentGuideImageEl.onerror = () => {
                        recentGuideImageEl.removeAttribute("src");
                        recentGuideImageEl.hidden = true;
                    };
                    if (latest.image) {
                        recentGuideImageEl.src = latest.image;
                        recentGuideImageEl.hidden = false;
                    } else {
                        recentGuideImageEl.removeAttribute("src");
                        recentGuideImageEl.hidden = true;
                    }
                }
                shareSectionEl.hidden = false;
                detailEl.hidden = false;
                await loadRecommendedTests(found.testId || "");
            }

            function waitForFirebaseConfig(attempt) {
                if (window.firebaseServices || attempt > 40) {
                    initResultPage().catch(() => {
                        emptyEl.hidden = false;
                    });
                    return;
                }
                setTimeout(() => waitForFirebaseConfig(attempt + 1), 50);
            }

            try {
                waitForFirebaseConfig(0);
            } catch (error) {
                emptyEl.hidden = false;
            }
        })();
    </script>
</body>
</html>
